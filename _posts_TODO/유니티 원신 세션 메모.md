TITLE : 유니티 원신 세션 메모

# Links
---
- [원신 유니티 세션(유나이트 서울 2020)](https://www.youtube.com/watch?v=00QugD5u1CU)
- [원신 유니티 세션 분석하기](https://www.youtube.com/watch?v=t0rOOs1701o)



각각

1:13:02
0:23:00

Volumetric Fog 보는중





# 그림자
---

## Poisson Noise
- 푸아송 노이즈를 통해 더 가성비 좋은 Soft Shadow를 구현했다.

## 8 Shadow Cascades
- 유니티는 기본적으로 4 Cascade 그림자를 지원하는데, 원신은 커스텀을 통해 8 Cascade 그림자를 구현했다.

- 8 Cascade를 사용하는데 성능을 끌어올리기 위한 방법?
  - 8 Cascade 중에 가장 가까운 4개는 매프레임 갱신한다.
  - 먼 4개는 프레임마다 하나씩만 갱신하여 최대 8프레임마다 갱신한다.
  - 따라서 프레임당 원래는 8개를 갱신해야 하는데 5개씩만 갱신하여 드로우콜을 크게 줄였다.

- Screen Space Shadow Map을 사용했다.

## Penumbra Area
- Soft Shadow는 사실상 엣지 부분에서만 의미가 있다.
  따라서 Penumbra Area(반그림자, 가장자리) 영역에만 Soft Shadow를 적용함으로써
  처리에 2 ~ 2.6ms가 소요되던 것을 1.3 ~ 1.7ms까지 성능을 끌어올렸다.

- 섀도우 마스크 텍스쳐에서 가장자리 영역을 검출하여, 중앙 영역은 0 or 1만 반환하고
  가장자리에서만 0 ~ 1 사이의 값을 통해 Soft Shadow를 적용한다.

- 결과적으로 GPU 성능 소모를 30% 절감했다.

## Shadow Mask Map 
- Mask Map은 그림자가 없는 영역, 반그림자 영역(Soft Shadow), 그림자 영역(Hard Shadow)을 구분한다.
- Mask Map의 각 픽셀은 SS Shadow Map의 16개 픽셀에 대응된다.
- 다시 말해, Mask Map의 해상도는 SS Shadow Map의 1/16 이다.

- 원래는 SS Shadow Map에서 픽셀 16개를 뽑아 평균을 구하고, 그 결과를 Mask Map의 한 픽셀에 넣는다.
- 이렇게 하면 정확하기는 하지만 오래 걸린다는 단점이 있다.

- 따라서 16 -> 1 픽셀의 값을 결정할 때 16개 픽셀을 모두 사용하는 것이 아니라 16개 중에서 몇 개의 픽셀만 뽑아서 계산한다.
- 이렇게 하면 빨라지기는 하지만 부정확한 결과를 낼 수 있다.

- 따라서 결과 Mask Map 텍스쳐에 블러를 적용하는 패스를 추가한다.
- 블러링을 통해 적절히 보간된 결과를 얻을 수 있지만, 정확한 No Shadow/Penumbra/Shadow 영역을 판단하지 못하고
  서로의 영역을 약간 침범한다는 단점이 있으나 이 정도는 괜찮다.

- 이렇게 Mask Map을 통해 그림자 영역을 구분하는 연산을 최적화하여,
  결과적으로 전체 Mask Map을 생성하는 데 0.3ms가 걸리도록 할 수 있었다.

- Mask Map 생성 연산은 컴퓨트 쉐이더를 이용해 이루어진다.


# Ambient Occlusion
---

## 대상에 따라 다른 AO 적용
- 대상의 종류에 따라 3가지 AO를 다르게 사용한다.
- 작은 영역 : HBAO (실시간 스크린 스페이스 처리 - 화면 전체적으로 적용)
- 정적 오브젝트 : AO Volume(미리 베이크해서 사용)
- 캐릭터 : Capsule AO(실시간 적용)

> ### NOTE
> - HBAO : Horizion Based Ambient Occlusion
> - HBAO는 무거워서 NVIDIA에서도 3배정도 더 가벼운 HBAO+를 만들었을 정도다.


## AO 렌더 패스
- AO를 그리기 위한 렌더 패스를 따로 적용한다.
- AO 렌더 텍스쳐는 `1/2 * 1/2 = 1/4` 해상도
- 작은 크기의 렌더 텍스쳐에서 AO를 계산하고, 업샘플링을 수행한 뒤 가우시안 블러를 적용한다.
- 하나의 패스에서 컴퓨트 쉐이더를 통해 계산한다.


# Local Lighting(지역 광원)
---

## 라이팅 처리 기법
- 클러스터 기반 디퍼드 라이팅(Clustered Deferred Lighting)을 사용한다.
- 동시에 1024개의 실시간 라이트를 사용할 수 있다.
- 스크린은 `64 x 64` 크기의 픽셀 타일로 나뉘며, 각 타일은 Depth에 따라 16개의 클러스터로 다시 나뉜다.
- 결과적으로 클러스터 개수 = `Width/64 * Height/64 * 16(Z)` 만큼 나누어 실시간 라이트를 계산한다.

- 스크린을 타일로 쪼개는 방식이 먼저 고안되었고, 이는 화면 그대로 2D 계산이 이루어진다.
- 스크린을 타일로 쪼갠 뒤 여기에서 Depth에 따라 클러스터를 나누는 방식은 이후에 고안된 방식인데,
  이를 이용하면 마치 3D처럼 계산이 이루어지고, Depth가 깊어서 멀리 있는 라이트에 경우에는 상대적으로 간단히 계산하여
  보다 효율적인 실시간 라이트 계산을 수행할 수 있다.

- 클러스터 기반 디퍼드 라이팅 기법은 HDRP의 볼류메트릭 라이트에서도 사용된다.
- 이 방식은 기존의 포워드, 디퍼드와도 모두 별개라고 여기는 것이 좋다.

- 클러스터마다 라이트가 최대한 균일하게 분포하고, 한 클러스터에 뭉치지 않도록 하는 것이 좋다. 뭉치면 병목의 원인이 된다.

## 지역 광원의 실시간 그림자
- 거의 100개의 광원으로부터 실시간 그림자를 연산할 수 있다. (더 많이 가능하지만 이 정도면 충분)
- 거리와 우선순위를 기반으로 각각의 쉐도우 맵 해상도를 결정한다.

## 베이크된 쉐도우 텍스쳐
- 정적 오브젝트의 쉐도우 텍스쳐는 미리 베이크되고, 압축된다.
- 런타임에 컴퓨트 쉐이더를 통해 0.05ms 만에 `1k * 1k` 크기의 쉐도우 텍스쳐를 압축 해제해서 사용할 수 있다.
- 압축률이 무려 20~30배에 달한다.
- 압축 시 정밀도를 아티스트가 결정하고 확인할 수 있게 만들었다고 한다.
- 고정밀도와 저정밀도의 압축 결과를 맨 눈으로 확인하기 어려울 정도다.


# Volumetric Fog
---

- 라이트 스캐터링 연산을 별도로 수행한다.
- 지역 광원은 Projection Texture를 갖고 있다.
- 