TITLE : 교활한 클라이언트와 똑똑한 서버

# 강좌
---
- <https://www.inflearn.com/course/유니티-mmorpg-개발-part4>

<br>

# Note
---

서버를 만들 때 반드시 가정해야 하는 것이 있다.

바로 '클라이언트는 교활하다' 라는 가정이다.

그리고 이에 맞서서 서버는 가능한 모든 경우에 대처할 수 있도록,

최대한 똑똑하고 유연하게 작성해야 한다.

<br>

## **TCP 패킷 수신 방식의 취약점**

현재 패킷을 수신할 경우, 패킷의 첫 2바이트를 열어보고 크기를 결정한다.

여기서 첫번째 취약점이 발생한다.

바로 클라이언트로부터 받은 패킷의 값으로부터, 중요한 정보인 '길이'를 의존한다는 것이다.

그리고 TCP의 특성상 패킷이 한 번에 도착하지 않고 나뉘어 올 수 있으므로

일단 받은 패킷의 헤더를 열어보고, 여기서 읽어낸 길이보다 패킷이 짧으면

그 패킷을 처리하지 않고 버퍼에 그대로 유지한다.

여기서 두번째 취약점이 발생한다.

위의 두가지 취약점으로 인해,

예를들어 클라이언트가 패킷의 길이에 `0xFFFF`라고 작성해서 보내면

총 길이 `65,535`의 패킷을 받을 때까지

그 어떤 패킷을 받더라도 당장 처리하지 않고 계속 패킷을 조립하며 기다리게 되는 것이다.

<br>

따라서 여기서 서버에 필요한 처리는 다음과 같다.

1. 헤더를 확인할 때, `Size` 뿐만 아니라 `ID`까지 확인하기 위해 총 `4바이트`를 확인한다.

2. `ID`에 따른 패킷 타입은 미리 결정되어 있으므로, 각 패킷 타입마다 가능한 `MaxSize`(최대 길이)를 테이블(배열)을 통해 미리 정해놓는다.

3. `ID`를 열어보고 `MaxSize`를 확인한 다음, `Size`를 열어본 뒤 `Size`가 `MaxSize`보다 크면 그 시점까지 받았던 모든 패킷을 버퍼에서 폐기한다.

<br>

위와 같이 처리할 경우, 서버는 더이상 클라이언트가 보내주는 패킷 길이 정보에 완전히 의존하지 않고

서버가 저장하고 있던 자신의 `MaxSize` 데이터에 우선 의존하므로

잘못된 길이 데이터에도 좀더 유연하게 대처할 수 있게 된다.






# References
---
- <https://www.inflearn.com/course/유니티-mmorpg-개발-part4>







