<!DOCTYPE html>



<html lang="en" 
  
    mode="dark"
  
>

  <!--
  The Head
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="theme" content="Chirpy v2.7.2">

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="유니티 - 진공 청소기, 먼지 시뮬레이션" />
<meta name="author" content="Rito15" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="목표 수십만 개의 먼지를 렌더링한다. 먼지들의 움직임을 시뮬레이션한다. 진공 청소기로 먼지들을 예쁘게 빨아들인다." />
<meta property="og:description" content="목표 수십만 개의 먼지를 렌더링한다. 먼지들의 움직임을 시뮬레이션한다. 진공 청소기로 먼지들을 예쁘게 빨아들인다." />
<link rel="canonical" href="https://rito15.github.io/posts/unity-million-dust-simulation/" />
<meta property="og:url" content="https://rito15.github.io/posts/unity-million-dust-simulation/" />
<meta property="og:site_name" content="Rito15" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-09-27T17:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="유니티 - 진공 청소기, 먼지 시뮬레이션" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"description":"목표 수십만 개의 먼지를 렌더링한다. 먼지들의 움직임을 시뮬레이션한다. 진공 청소기로 먼지들을 예쁘게 빨아들인다.","datePublished":"2021-09-27T17:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://rito15.github.io/posts/unity-million-dust-simulation/"},"url":"https://rito15.github.io/posts/unity-million-dust-simulation/","author":{"@type":"Person","name":"Rito15"},"headline":"유니티 - 진공 청소기, 먼지 시뮬레이션","dateModified":"2021-09-27T17:00:00+09:00","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>유니티 - 진공 청소기, 먼지 시뮬레이션 | Rito15
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://www.favicon-generator.org/
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2019 Cotes Chung
  Published under the MIT license
-->



<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon">
<link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon">

<link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png">
<link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png">
<link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png">

<link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

<link rel="manifest" href="/assets/img/favicons/manifest.json">
<meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'>
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous">

  <!-- Font Awesome -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"
    integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ="
    crossorigin="anonymous">

  <!--
  CSS selector for site.
  Chirpy v2.3
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT Licensed
-->






<link rel="preload" href="/assets/css/post.css" as="style">
<link rel="stylesheet" href="/assets/css/post.css">


  
    <link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css">
    <link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" />
  



  <!-- JavaScripts -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  <script defer
    src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>

  <!--
  JS selector for site.
  Chirpy v2.3
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT Licensed
-->





<script async src="/assets/js/post.min.js"></script>


  <!-- MathJax -->
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>





</head>


  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->

<div id="sidebar" class="d-flex flex-column align-items-end">

  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        <img src="/assets/img/favicons/android-icon-192x192.png" alt="avatar" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Rito15</a>
    </div>

    <div class="site-subtitle font-italic">Unity Csharp Developer</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">
    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/tabs/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tabs/tags/" class="nav-link">
        <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i>
        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tabs/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tabs/about/" class="nav-link">
        <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center">

    
      

      
      <a href="https://github.com/rito15" aria-label="github"
        
        target="_blank" rel="noopener">
        <i class="fab fa-github-alt"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['ghdtkals15','gmail.com'].join('@')" aria-label="email"
        
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->
<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">
      
        
        <span>
          <a href="/">
            Posts
          </a>
        </span>
        
      

      
        <span>유니티 - 진공 청소기, 먼지 시뮬레이션</span>
      

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->


<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->


<!-- Add attribute 'hide-bullet' to the checkbox list -->




  

  

  <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->
  
  

  

  



<!-- return -->
<div class="row">

  <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">

    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

      <h1 data-toc-skip>유니티 - 진공 청소기, 먼지 시뮬레이션</h1>

      <div class="post-meta text-muted d-flex flex-column">
        <!-- Published date and author -->
        <div>
          <!--
  Date format snippet

  v2.4.1
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT License
-->
<span class="timeago "
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Mon, Sep 27, 2021,  5:00 PM +0900"
  >

  
  

  
    Sep 27
  

  <i class="unloaded">2021-09-27T17:00:00+09:00</i>

</span>
          by
          <span class="author">
            Rito15
          </span>
        </div>

        <div>
          <!-- lastmod -->
          

          <!-- read time -->
          <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->






<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4819 words">26 min</span>


          <!-- page views -->
          

          <!-- HITS -->
          &nbsp;
          <a href="https://hits.seeyoufarm.com"><img min-width="94" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https://rito15.github.io/posts/unity-million-dust-simulation/%2F&count_bg=%23AC58FA&title_bg=%23555555&icon=&icon_color=%23E7E7E7&title=views&edge_flat=false"/></a> 

        </div>

      </div> <!-- .post-meta -->

      <div class="post-content">

        

        <h1 id="목표">목표</h1>
<hr />
<ul>
  <li>수십만 개의 먼지를 렌더링한다.</li>
  <li>먼지들의 움직임을 시뮬레이션한다.</li>
  <li>진공 청소기로 먼지들을 예쁘게 빨아들인다.</li>
</ul>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="주요-개념">주요 개념</h1>
<hr />

<h2 id="compute-buffer"><strong>Compute Buffer</strong></h2>
<ul>
  <li>큰 병렬 데이터를 GPU에 전달하거나 쉐이더끼리 공유하기 위해 사용한다.</li>
  <li>Vert/Frag, Compute Shader에서 <code class="language-plaintext highlighter-rouge">StructuredBuffer&lt;T&gt;</code> 타입 변수로 사용할 수 있다.</li>
</ul>

<h2 id="graphicsdrawmeshinstancedindirect"><strong>Graphics.DrawMeshInstancedIndirect()</strong></h2>
<ul>
  <li>컴퓨트 버퍼의 메시 데이터를 GPU Instancing을 적용하여 대규모로 렌더링할 수 있다.</li>
</ul>

<h2 id="compute-shader"><strong>Compute Shader</strong></h2>
<ul>
  <li>GPGPU를 통해 병렬적으로 연산을 적용할 수 있다.</li>
</ul>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="1-10만개의-먼지-만들기">1. 10만개의 먼지 만들기</h1>
<hr />

<p>렌더링될 메시의 버텍스 개수에 따라 성능 차이가 커지므로,</p>

<p>일단 메시는 단순한 큐브 메시를 사용한다.</p>

<p><br /></p>

<h2 id="dustmanagercs"><strong>Dustmanager.cs</strong></h2>

<ul>
  <li>먼지 생성 및 관리를 담당한다.</li>
</ul>

<details>
  <summary> 
Fields
</summary>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">TRUE</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
<span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">FALSE</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

<span class="k">private</span> <span class="k">struct</span> <span class="nc">Dust</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Vector3</span> <span class="n">position</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">isAlive</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Dust Options"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Mesh</span> <span class="n">DustMesh</span><span class="p">;</span>         <span class="c1">// 먼지 메시</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Material</span> <span class="n">DustMaterial</span><span class="p">;</span> <span class="c1">// 먼지 마테리얼</span>

<span class="p">[</span><span class="n">Space</span><span class="p">]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">int</span> <span class="n">instanceNumber</span> <span class="p">=</span> <span class="m">100000</span><span class="p">;</span>    <span class="c1">// 생성할 먼지 개수</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">distributionRange</span> <span class="p">=</span> <span class="m">100f</span><span class="p">;</span> <span class="c1">// 먼지 분포 범위(정사각형 너비)</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">2f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">DustScale</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>           <span class="c1">// 먼지 크기</span>

<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">DustBuffer</span><span class="p">;</span> <span class="c1">// 먼지 데이터 버퍼(위치, ...)</span>
<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">argsBuffer</span><span class="p">;</span> <span class="c1">// 먼지 렌더링 데이터 버퍼</span>

<span class="k">private</span> <span class="n">Bounds</span> <span class="n">frustumOverlapBounds</span><span class="p">;</span>
<span class="k">private</span> <span class="n">Dust</span><span class="p">[]</span> <span class="n">DustArray</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<details>
  <summary> 
Unity Event Methods
</summary>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">InitBuffers</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"_Scale"</span><span class="p">,</span> <span class="n">DustScale</span><span class="p">);</span>
    <span class="n">Graphics</span><span class="p">.</span><span class="nf">DrawMeshInstancedIndirect</span><span class="p">(</span><span class="n">DustMesh</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">DustMaterial</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">argsBuffer</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DustBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
    <span class="n">argsBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">private</span> <span class="n">GUIStyle</span> <span class="n">boxStyle</span><span class="p">;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">OnGUI</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">boxStyle</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">boxStyle</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GUIStyle</span><span class="p">(</span><span class="n">GUI</span><span class="p">.</span><span class="n">skin</span><span class="p">.</span><span class="n">box</span><span class="p">);</span>
        <span class="n">boxStyle</span><span class="p">.</span><span class="n">fontSize</span> <span class="p">=</span> <span class="m">48</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">float</span> <span class="n">scWidth</span> <span class="p">=</span> <span class="n">Screen</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">scHeight</span> <span class="p">=</span> <span class="n">Screen</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
    <span class="n">Rect</span> <span class="n">r</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="n">scWidth</span> <span class="p">*</span> <span class="m">0.04f</span><span class="p">,</span> <span class="n">scHeight</span> <span class="p">*</span> <span class="m">0.04f</span><span class="p">,</span> <span class="n">scWidth</span> <span class="p">*</span> <span class="m">0.25f</span><span class="p">,</span> <span class="n">scHeight</span> <span class="p">*</span> <span class="m">0.05f</span><span class="p">);</span>

    <span class="n">GUI</span><span class="p">.</span><span class="nf">Box</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">$"</span><span class="p">{</span><span class="n">aliveNumber</span><span class="p">:</span><span class="n">D6</span><span class="p">}</span><span class="s"> / </span><span class="p">{</span><span class="n">instanceNumber</span><span class="p">}</span><span class="s">"</span><span class="p">,</span> <span class="n">boxStyle</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<details>
  <summary> 
Methods
</summary>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="c1">/// &lt;summary&gt; 컴퓨트 버퍼들 생성 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitBuffers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Args Buffer</span>
    <span class="c1">// IndirectArguments로 사용되는 컴퓨트 버퍼의 stride는 20byte 이상이어야 한다.</span>
    <span class="c1">// 따라서 파라미터가 앞의 2개만 필요하지만, 뒤에 의미 없는 파라미터 3개를 더 넣어준다.</span>
    <span class="kt">uint</span><span class="p">[]</span> <span class="n">argsData</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">DustMesh</span><span class="p">.</span><span class="nf">GetIndexCount</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">};</span>
    <span class="n">aliveNumber</span> <span class="p">=</span> <span class="n">instanceNumber</span><span class="p">;</span>

    <span class="n">argsBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">5</span> <span class="p">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="n">ComputeBufferType</span><span class="p">.</span><span class="n">IndirectArguments</span><span class="p">);</span>
    <span class="n">argsBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">argsData</span><span class="p">);</span>

    <span class="nf">PopulateDusts</span><span class="p">();</span>

    <span class="c1">// Dust Buffer</span>
    <span class="n">DustBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span> <span class="p">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="n">DustBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">DustArray</span><span class="p">);</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="s">"_DustBuffer"</span><span class="p">,</span> <span class="n">DustBuffer</span><span class="p">);</span>

    <span class="c1">// 카메라 프러스텀이 이 영역과 겹치지 않으면 렌더링되지 않는다.</span>
    <span class="n">frustumOverlapBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bounds</span><span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">distributionRange</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="n">distributionRange</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 먼지들을 영역 내의 무작위 위치에 생성한다. &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">PopulateDusts</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DustArray</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dust</span><span class="p">[</span><span class="n">instanceNumber</span><span class="p">];</span>

    <span class="kt">float</span> <span class="n">min</span> <span class="p">=</span> <span class="p">-</span><span class="m">0.5f</span> <span class="p">*</span> <span class="n">distributionRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">max</span> <span class="p">=</span> <span class="p">-</span><span class="n">min</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">instanceNumber</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">float</span> <span class="n">x</span> <span class="p">=</span> <span class="n">UnityEngine</span><span class="p">.</span><span class="n">Random</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">z</span> <span class="p">=</span> <span class="n">UnityEngine</span><span class="p">.</span><span class="n">Random</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
        <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
        <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="p">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><br /></p>

<h2 id="dustshadershader"><strong>DustShader.shader</strong></h2>

<ul>
  <li>
    <p>먼지 렌더링을 담당한다.</p>
  </li>
  <li>
    <p>먼지의 위치를 컴퓨트 버퍼에 저장하면, CPU가 아니라 쉐이더를 통해 GPU로 위치 변경사항을 적용한다.</p>
  </li>
</ul>

<details>
  <summary> 
…
</summary>

  <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="rouge-code"><pre><span class="n">Shader</span> <span class="s">"Rito/Dust"</span>
<span class="p">{</span>
    <span class="n">Properties</span>
    <span class="p">{</span>
        <span class="c1">//_MainTex ("Texture", 2D) = "white" {}</span>
        <span class="n">_Color</span><span class="p">(</span><span class="s">"Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">SubShader</span>
    <span class="p">{</span>
        <span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="p">}</span>

        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>
            <span class="cp">#include "UnityCG.cginc"
</span>            <span class="cp">#define TRUE 1
</span>            <span class="cp">#define FALSE 0
</span>
            <span class="k">struct</span> <span class="n">v2f</span>
            <span class="p">{</span>
                <span class="kt">float4</span> <span class="n">pos</span> <span class="o">:</span> <span class="nb">SV_POSITION</span><span class="p">;</span>
                <span class="kt">float3</span> <span class="n">normal</span> <span class="o">:</span> <span class="nb">TEXCOORD0</span><span class="p">;</span>
                <span class="n">int</span> <span class="n">isAlive</span> <span class="o">:</span> <span class="nb">TEXCOORD1</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="k">struct</span> <span class="n">Dust</span>
            <span class="p">{</span>
                <span class="kt">float3</span> <span class="n">position</span><span class="p">;</span>
                <span class="n">int</span> <span class="n">isAlive</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="k">uniform</span> <span class="n">float</span> <span class="n">_Scale</span><span class="p">;</span>
            <span class="kt">StructuredBuffer</span><span class="o">&lt;</span><span class="n">Dust</span><span class="o">&gt;</span> <span class="n">_DustBuffer</span><span class="p">;</span>

            <span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata_full</span> <span class="n">v</span><span class="p">,</span> <span class="n">uint</span> <span class="n">instanceID</span> <span class="o">:</span> <span class="n">SV_InstanceID</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="c1">// 먼지 생존 여부 받아와서 프래그먼트 쉐이더에 전달</span>
                <span class="n">o</span><span class="p">.</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">_DustBuffer</span><span class="p">[</span><span class="n">instanceID</span><span class="p">].</span><span class="n">isAlive</span><span class="p">;</span>

                <span class="c1">// 먼지 크기 결정</span>
                <span class="n">v</span><span class="p">.</span><span class="n">vertex</span> <span class="o">*=</span> <span class="n">_Scale</span><span class="p">;</span> 

                <span class="c1">// 먼지 위치 결정</span>
                <span class="kt">float3</span> <span class="n">instancePos</span> <span class="o">=</span> <span class="n">_DustBuffer</span><span class="p">[</span><span class="n">instanceID</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
                <span class="kt">float3</span> <span class="n">worldPos</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span> <span class="o">+</span> <span class="n">instancePos</span><span class="p">;</span>

                <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_VP</span><span class="p">,</span> <span class="kt">float4</span><span class="p">(</span><span class="n">worldPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
                <span class="n">o</span><span class="p">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">fixed4</span> <span class="n">_Color</span><span class="p">;</span>

            <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
            <span class="p">{</span>
                <span class="c1">// 죽은 먼지는 렌더링 X</span>
                <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">discard</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="n">_Color</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><br /></p>

<h2 id="실행-결과"><strong>실행 결과</strong></h2>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/134875331-f70f4555-7b70-49a6-8049-ae35740165a0.gif" alt="2021_0927_Dust1" /></p>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="2-먼지-빨아들이기">2. 먼지 빨아들이기</h1>
<hr />

<h2 id="진공-청소기-입구"><strong>진공 청소기 입구</strong></h2>

<ul>
  <li>먼지를 빨아들이는 부분</li>
</ul>

<details>
  <summary> 
VacuumCleanerHead.cs
</summary>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">bool</span> <span class="n">run</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">50f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">suctionForce</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1f</span><span class="p">,</span> <span class="m">20f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">suctionRange</span> <span class="p">=</span> <span class="m">5f</span><span class="p">;</span>
<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">5f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">deathRange</span> <span class="p">=</span> <span class="m">0.2f</span><span class="p">;</span>

<span class="k">public</span> <span class="kt">bool</span> <span class="n">Running</span> <span class="p">=&gt;</span> <span class="n">run</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">SqrSuctionRange</span> <span class="p">=&gt;</span> <span class="n">suctionRange</span> <span class="p">*</span> <span class="n">suctionRange</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">SuctionForce</span> <span class="p">=&gt;</span> <span class="n">suctionForce</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">DeathRange</span> <span class="p">=&gt;</span> <span class="n">deathRange</span><span class="p">;</span>
<span class="k">public</span> <span class="n">Vector3</span> <span class="n">Position</span> <span class="p">=&gt;</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">OnDrawGizmosSelected</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Gizmos</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">cyan</span><span class="p">;</span>
    <span class="n">Gizmos</span><span class="p">.</span><span class="nf">DrawWireSphere</span><span class="p">(</span><span class="n">Position</span><span class="p">,</span> <span class="n">suctionRange</span><span class="p">);</span>

    <span class="n">Gizmos</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">;</span>
    <span class="n">Gizmos</span><span class="p">.</span><span class="nf">DrawWireSphere</span><span class="p">(</span><span class="n">Position</span><span class="p">,</span> <span class="n">deathRange</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><br /></p>

<h2 id="1-cpu-단일-스레드-계산"><strong>[1] CPU 단일 스레드 계산</strong></h2>

<ul>
  <li>반복문을 통한 단순 계산을 통해 먼지들의 위치를 업데이트한다.</li>
  <li>성능이 매우 매우 좋지 않다.</li>
</ul>

<details>
  <summary> 
Dustmanager.cs
</summary>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">UpdateDustPositions</span><span class="p">();</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"_Scale"</span><span class="p">,</span> <span class="n">DustScale</span><span class="p">);</span>
    <span class="n">Graphics</span><span class="p">.</span><span class="nf">DrawMeshInstancedIndirect</span><span class="p">(</span><span class="n">DustMesh</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">DustMaterial</span><span class="p">,</span> <span class="n">frustumOverlapBounds</span><span class="p">,</span> <span class="n">argsBuffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositions</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cleanerHead</span><span class="p">.</span><span class="n">Running</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">centerPos</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SqrSuctionRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrDeathRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">force</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionForce</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">instanceNumber</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="p">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// root 연산은 비싸기 때문에 제곱 상태로 거리 비교</span>
        <span class="kt">float</span> <span class="n">sqrDist</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="nf">SqrMagnitude</span><span class="p">(</span><span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="p">-</span> <span class="n">centerPos</span><span class="p">);</span>
        
        <span class="c1">// 사망 범위</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="p">&lt;</span> <span class="n">sqrDeathRange</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="p">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">aliveNumber</span><span class="p">--;</span>
        <span class="p">}</span>
        <span class="c1">// 흡입 범위</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="p">&lt;</span> <span class="n">sqrRange</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="nf">Lerp</span><span class="p">(</span><span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">,</span> <span class="n">centerPos</span><span class="p">,</span> <span class="n">force</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">DustBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">DustArray</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/134880151-4068c99e-a84d-4cdb-8f49-5e88eb31ea89.gif" alt="2021_0927_DustUpdate1" /></p>

<p><br /></p>

<h2 id="2-cpu-병렬-계산"><strong>[2] CPU 병렬 계산</strong></h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Parallel</code>을 통한 멀티스레딩으로 CPU 연산을 적용한다.</p>
  </li>
  <li>
    <p>그리고 먼지가 단순히 <code class="language-plaintext highlighter-rouge">Vector3.Lerp()</code>를 통해 이동하는 대신, 거리가 가까울수록 빠르게 이동하도록 계산 방식을 변경한다.</p>
  </li>
</ul>

<details>
  <summary> 
Dustmanager.cs
</summary>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositions</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cleanerHead</span><span class="p">.</span><span class="n">Running</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">centerPos</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SqrSuctionRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrDeathRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrForce</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionForce</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionForce</span><span class="p">;</span>

    <span class="c1">// 병렬 처리(동기)</span>
    <span class="n">Parallel</span><span class="p">.</span><span class="nf">For</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">instanceNumber</span><span class="p">,</span> <span class="n">i</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="p">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="kt">float</span> <span class="n">sqrDist</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="nf">SqrMagnitude</span><span class="p">(</span><span class="n">centerPos</span> <span class="p">-</span> <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>

        <span class="c1">// 사망 범위</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="p">&lt;</span> <span class="n">sqrDeathRange</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="p">=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Interlocked</span><span class="p">.</span><span class="nf">Decrement</span><span class="p">(</span><span class="k">ref</span> <span class="n">aliveNumber</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// 흡입 범위</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="p">&lt;</span> <span class="n">sqrRange</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Vector3</span> <span class="n">dir</span> <span class="p">=</span> <span class="p">(</span><span class="n">centerPos</span> <span class="p">-</span> <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">).</span><span class="n">normalized</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">weightedForce</span> <span class="p">=</span> <span class="n">sqrForce</span> <span class="p">/</span> <span class="n">sqrDist</span><span class="p">;</span>
            <span class="n">DustArray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="p">+=</span> <span class="n">dir</span> <span class="p">*</span> <span class="n">weightedForce</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="n">DustBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">DustArray</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/134881462-c07f57ba-097c-41fd-87f6-f2639c53f463.gif" alt="2021_0927_DustUpdate2" /></p>

<p><br /></p>

<h2 id="3-컴퓨트-쉐이더-병렬-연산"><strong>[3] 컴퓨트 쉐이더 병렬 연산</strong></h2>

<ul>
  <li>먼지 이동 연산을 컴퓨트 쉐이더로 넘겨서 처리한다.</li>
  <li>컴퓨트 쉐이더의 연산 결과를 다시 CPU로 가져오는 작업이 없고, 대신 컴퓨트 버퍼를 Vert/Frag 쉐이더에서 바로 참조하여 적용하므로 매우 빠르다.</li>
</ul>

<details>
  <summary> 
DustCompute.compute
</summary>

  <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="cp">#pragma kernel CSMain
</span>
<span class="cp">#define TRUE 1
#define FALSE 0
</span>
<span class="k">struct</span> <span class="n">Dust</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">int</span> <span class="n">isAlive</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">Dust</span><span class="o">&gt;</span> <span class="n">DustBuffer</span><span class="p">;</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">uint</span><span class="o">&gt;</span> <span class="n">aliveNumberBuffer</span><span class="p">;</span> <span class="c1">// 생존한 먼지 개수</span>

<span class="kt">float3</span> <span class="n">centerPos</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrRange</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrDeathRange</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrForce</span><span class="p">;</span>

<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">CSMain</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    
    <span class="c1">// 제곱 상태로 연산</span>
    <span class="kt">float3</span> <span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">centerPos</span> <span class="o">-</span> <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">sqrDist</span> <span class="o">=</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

    <span class="c1">// 사망 범위</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrDeathRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="nb">InterlockedAdd</span><span class="p">(</span><span class="n">aliveNumberBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 흡입 범위</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float3</span> <span class="n">dir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">centerPos</span> <span class="o">-</span> <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>
        <span class="n">float</span> <span class="n">weightedForce</span> <span class="o">=</span> <span class="n">sqrForce</span> <span class="o">/</span> <span class="n">sqrDist</span><span class="p">;</span>
        <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">+=</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">weightedForce</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<details>
  <summary> 
Dustmanager.cs
</summary>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
</pre></td><td class="rouge-code"><pre><span class="cm">/* 기타 필드 생략 */</span>

<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">ComputeShader</span> <span class="n">DustCompute</span><span class="p">;</span>
<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">DustBuffer</span><span class="p">;</span> <span class="c1">// 먼지 데이터 버퍼(위치, ...)</span>
<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">argsBuffer</span><span class="p">;</span> <span class="c1">// 먼지 렌더링 데이터 버퍼</span>
<span class="k">private</span> <span class="n">ComputeBuffer</span> <span class="n">aliveNumberBuffer</span><span class="p">;</span> <span class="c1">// 생존 먼지 개수 RW</span>

<span class="k">private</span> <span class="n">Bounds</span> <span class="n">frustumOverlapBounds</span><span class="p">;</span>
<span class="k">private</span> <span class="n">Dust</span><span class="p">[]</span> <span class="n">DustArray</span><span class="p">;</span>

<span class="k">private</span> <span class="kt">uint</span><span class="p">[]</span> <span class="n">aliveNumberArray</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">int</span> <span class="n">aliveNumber</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">kernelGroupSizeX</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">InitBuffers</span><span class="p">();</span>
    <span class="nf">InitComputeShader</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">UpdateDustPositionsGPU</span><span class="p">();</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"_Scale"</span><span class="p">,</span> <span class="n">DustScale</span><span class="p">);</span>
    <span class="n">Graphics</span><span class="p">.</span><span class="nf">DrawMeshInstancedIndirect</span><span class="p">(</span><span class="n">DustMesh</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">DustMaterial</span><span class="p">,</span> <span class="n">frustumOverlapBounds</span><span class="p">,</span> <span class="n">argsBuffer</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DustBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
    <span class="n">argsBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
    <span class="n">aliveNumberBuffer</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 컴퓨트 버퍼들 생성 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitBuffers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Args Buffer</span>
    <span class="c1">// IndirectArguments로 사용되는 컴퓨트 버퍼의 stride는 20byte 이상이어야 한다.</span>
    <span class="c1">// 따라서 파라미터가 앞의 2개만 필요하지만, 뒤에 의미 없는 파라미터 3개를 더 넣어준다.</span>
    <span class="kt">uint</span><span class="p">[]</span> <span class="n">argsData</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">DustMesh</span><span class="p">.</span><span class="nf">GetIndexCount</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">};</span>
    <span class="n">aliveNumber</span> <span class="p">=</span> <span class="n">instanceNumber</span><span class="p">;</span>

    <span class="n">argsBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">5</span> <span class="p">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="n">ComputeBufferType</span><span class="p">.</span><span class="n">IndirectArguments</span><span class="p">);</span>
    <span class="n">argsBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">argsData</span><span class="p">);</span>

    <span class="nf">PopulateDusts</span><span class="p">();</span>

    <span class="c1">// Dust Buffer</span>
    <span class="n">DustBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span> <span class="p">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="n">DustBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">DustArray</span><span class="p">);</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="s">"_DustBuffer"</span><span class="p">,</span> <span class="n">DustBuffer</span><span class="p">);</span>

    <span class="c1">// Alive Number Buffer</span>
    <span class="c1">// 단순 입력용이 아니라 RW이므로 컴퓨트 버퍼를 사용한다.</span>
    <span class="n">aliveNumberBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">));</span>
    <span class="n">aliveNumberArray</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">};</span>
    <span class="n">aliveNumberBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">aliveNumberArray</span><span class="p">);</span>

    <span class="c1">// 카메라 프러스텀이 이 영역과 겹치지 않으면 렌더링되지 않는다.</span>
    <span class="n">frustumOverlapBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bounds</span><span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">distributionRange</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="n">distributionRange</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 컴퓨트 쉐이더 초기화 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitComputeShader</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="s">"DustBuffer"</span><span class="p">,</span> <span class="n">DustBuffer</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="s">"aliveNumberBuffer"</span><span class="p">,</span> <span class="n">aliveNumberBuffer</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">GetKernelThreadGroupSizes</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="k">out</span> <span class="kt">uint</span> <span class="n">tx</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">);</span>
    <span class="n">kernelGroupSizeX</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">CeilToInt</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">/</span> <span class="n">tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositionsGPU</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cleanerHead</span><span class="p">.</span><span class="n">Running</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">centerPos</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SqrSuctionRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrDeathRange</span> <span class="p">=</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">DeathRange</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">sqrForce</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionForce</span> <span class="p">*</span> <span class="n">cleanerHead</span><span class="p">.</span><span class="n">SuctionForce</span><span class="p">;</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetVector</span><span class="p">(</span><span class="s">"centerPos"</span><span class="p">,</span> <span class="n">centerPos</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"sqrRange"</span><span class="p">,</span> <span class="n">sqrRange</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"sqrDeathRange"</span><span class="p">,</span> <span class="n">sqrDeathRange</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"sqrForce"</span><span class="p">,</span> <span class="n">sqrForce</span><span class="p">);</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">kernelGroupSizeX</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>

    <span class="n">aliveNumberBuffer</span><span class="p">.</span><span class="nf">GetData</span><span class="p">(</span><span class="n">aliveNumberArray</span><span class="p">);</span>
    <span class="n">aliveNumber</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">aliveNumberArray</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/134906449-5b7787aa-a7f6-44cd-a151-c1b460fc6c7c.gif" alt="2021_0927_DustUpdate3" /></p>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="3-먼지-생성-최적화">3. 먼지 생성 최적화</h1>
<hr />

<p>난수를 발생시켜 먼지를 무작위 위치에 생성하던 부분을 CPU가 아니라 컴퓨트 쉐이더 내에서 연산하도록 한다.</p>

<p>그리고 평면이 아닌, 공간에서 큐브 형태로 분포할 수 있도록 변경한다.</p>

<p><br /></p>

<h2 id="1-컴퓨트-쉐이더"><strong>[1] 컴퓨트 쉐이더</strong></h2>

<ul>
  <li>기존 커널의 이름을 <code class="language-plaintext highlighter-rouge">Update</code>로 변경하고, 새로운 커널 함수 <code class="language-plaintext highlighter-rouge">Populate</code>를 작성한다.</li>
</ul>

<details>
  <summary> 
DustCompute.compute
</summary>

  <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="rouge-code"><pre><span class="cp">#pragma kernel Populate
#pragma kernel Update
</span>
<span class="cp">#define TRUE 1
#define FALSE 0
</span>
<span class="k">struct</span> <span class="n">Dust</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">int</span> <span class="n">isAlive</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*************************************************
/*                     Methods
/*************************************************/</span>
<span class="n">float</span> <span class="nf">Random</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">frac</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="kt">float2</span><span class="p">(</span><span class="mi">73</span><span class="p">.</span><span class="mi">867</span><span class="p">,</span> <span class="mi">25</span><span class="p">.</span><span class="mi">241</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">39482</span><span class="p">.</span><span class="mi">17593</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">float</span> <span class="nf">RandomRange</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">,</span> <span class="n">float</span> <span class="nb">min</span><span class="p">,</span> <span class="n">float</span> <span class="nb">max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">lerp</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">Random</span><span class="p">(</span><span class="n">seed</span><span class="p">));</span> 
<span class="p">}</span>
<span class="kt">float3</span> <span class="nf">RandomRange3</span><span class="p">(</span><span class="kt">float2</span> <span class="n">seed</span><span class="p">,</span> <span class="kt">float3</span> <span class="nb">min</span><span class="p">,</span> <span class="kt">float3</span> <span class="nb">max</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">vec</span><span class="p">;</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">RandomRange</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="nb">min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">RandomRange</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="mi">7</span><span class="p">.</span><span class="mi">219</span><span class="p">,</span> <span class="nb">min</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">RandomRange</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="mi">79</span><span class="p">.</span><span class="mi">714</span><span class="p">,</span> <span class="nb">min</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="nb">max</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*************************************************
/*                     Variables
/*************************************************/</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">Dust</span><span class="o">&gt;</span> <span class="n">DustBuffer</span><span class="p">;</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">uint</span><span class="o">&gt;</span> <span class="n">aliveNumberBuffer</span><span class="p">;</span> <span class="c1">// 생존한 먼지 개수</span>

<span class="kt">float3</span> <span class="n">boundsMin</span><span class="p">;</span> <span class="c1">// 먼지 생성 영역 - 최소 지점</span>
<span class="kt">float3</span> <span class="n">boundsMax</span><span class="p">;</span> <span class="c1">// 먼지 생성 영역 - 최대 지점</span>

<span class="kt">float3</span> <span class="n">centerPos</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrRange</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrDeathRange</span><span class="p">;</span>
<span class="n">float</span> <span class="n">sqrForce</span><span class="p">;</span>

<span class="cm">/*************************************************
/*                     Kernels
/*************************************************/</span>

<span class="c1">// 0 - 초기 생성</span>
<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Populate</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

    <span class="n">float</span> <span class="n">width</span> <span class="o">=</span> <span class="n">boundsMax</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">boundsMin</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">float</span> <span class="n">f</span> <span class="o">=</span> <span class="n">float</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="kt">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="kt">float2</span><span class="p">(</span><span class="n">f</span> <span class="o">%</span> <span class="n">width</span><span class="p">,</span> <span class="n">f</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span><span class="p">;</span>
    
    <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">RandomRange3</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">boundsMin</span><span class="p">,</span> <span class="n">boundsMax</span><span class="p">);</span>
    <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 1 - 실시간 업데이트</span>
<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    
    <span class="kt">float3</span> <span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">centerPos</span> <span class="o">-</span> <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">sqrDist</span> <span class="o">=</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">offs</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">offs</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrDeathRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="nb">InterlockedAdd</span><span class="p">(</span><span class="n">aliveNumberBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float3</span> <span class="n">dir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">centerPos</span> <span class="o">-</span> <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>
        <span class="n">float</span> <span class="n">weightedForce</span> <span class="o">=</span> <span class="n">sqrForce</span> <span class="o">/</span> <span class="n">sqrDist</span><span class="p">;</span>
        <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">+=</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">weightedForce</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><br /></p>

<h2 id="2-먼지-관리-컴포넌트"><strong>[2] 먼지 관리 컴포넌트</strong></h2>

<ul>
  <li>커널 함수들의 인덱스를 필드로 저장한다.</li>
  <li>먼지들에 대한 CPU 작업은 더이상 필요하지 않으므로, <code class="language-plaintext highlighter-rouge">DustArray</code> 필드는 제거하고 모두 <code class="language-plaintext highlighter-rouge">DustBuffer</code>를 통해 GPU에서 작업한다.</li>
</ul>

<details>
  <summary> 
DustManager.cs
</summary>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">distributionHeight</span> <span class="p">=</span> <span class="m">5f</span><span class="p">;</span>  <span class="c1">// 먼지 분포 높이</span>

<span class="k">private</span> <span class="kt">int</span> <span class="n">kernelPopulateID</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">int</span> <span class="n">kernelUpdateID</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">int</span> <span class="n">kernelUpdateGroupSizeX</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">InitBuffers</span><span class="p">();</span>
    <span class="nf">InitComputeShader</span><span class="p">();</span>
    <span class="nf">PopulateDusts</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">UpdateDustPositionsGPU</span><span class="p">();</span>

    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"_Scale"</span><span class="p">,</span> <span class="n">DustScale</span><span class="p">);</span>
    <span class="n">Graphics</span><span class="p">.</span><span class="nf">DrawMeshInstancedIndirect</span><span class="p">(</span><span class="n">DustMesh</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">DustMaterial</span><span class="p">,</span> <span class="n">frustumOverlapBounds</span><span class="p">,</span> <span class="n">argsBuffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 컴퓨트 버퍼들 생성 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitBuffers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">uint</span><span class="p">[]</span> <span class="n">argsData</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">DustMesh</span><span class="p">.</span><span class="nf">GetIndexCount</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span> <span class="p">};</span>
    <span class="n">aliveNumber</span> <span class="p">=</span> <span class="n">instanceNumber</span><span class="p">;</span>

    <span class="n">argsBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">5</span> <span class="p">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="n">ComputeBufferType</span><span class="p">.</span><span class="n">IndirectArguments</span><span class="p">);</span>
    <span class="n">argsBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">argsData</span><span class="p">);</span>

    <span class="c1">// Dust Buffer =&gt; DustArray는 완전히 제거</span>
    <span class="n">DustBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">instanceNumber</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span> <span class="p">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="n">DustMaterial</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="s">"_DustBuffer"</span><span class="p">,</span> <span class="n">DustBuffer</span><span class="p">);</span>

    <span class="n">aliveNumberBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint</span><span class="p">));</span>
    <span class="n">aliveNumberArray</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">uint</span><span class="p">[]</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">};</span>
    <span class="n">aliveNumberBuffer</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">aliveNumberArray</span><span class="p">);</span>

    <span class="n">frustumOverlapBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bounds</span><span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">distributionRange</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="n">distributionRange</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 컴퓨트 쉐이더 초기화 &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">InitComputeShader</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 커널 인덱스 찾아 가져오기</span>
    <span class="n">kernelPopulateID</span> <span class="p">=</span> <span class="n">DustCompute</span><span class="p">.</span><span class="nf">FindKernel</span><span class="p">(</span><span class="s">"Populate"</span><span class="p">);</span>
    <span class="n">kernelUpdateID</span>   <span class="p">=</span> <span class="n">DustCompute</span><span class="p">.</span><span class="nf">FindKernel</span><span class="p">(</span><span class="s">"Update"</span><span class="p">);</span>

    <span class="c1">// 버퍼는 커널마다 각각 할당해주어야 한다.</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelPopulateID</span><span class="p">,</span> <span class="s">"DustBuffer"</span><span class="p">,</span> <span class="n">DustBuffer</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="s">"DustBuffer"</span><span class="p">,</span> <span class="n">DustBuffer</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="s">"aliveNumberBuffer"</span><span class="p">,</span> <span class="n">aliveNumberBuffer</span><span class="p">);</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">GetKernelThreadGroupSizes</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="k">out</span> <span class="kt">uint</span> <span class="n">tx</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">);</span>
    <span class="n">kernelUpdateGroupSizeX</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">CeilToInt</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">/</span> <span class="n">tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; 먼지들을 영역 내의 무작위 위치에 생성한다. &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">PopulateDusts</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Vector3</span> <span class="n">boundsMin</span><span class="p">,</span> <span class="n">boundsMax</span><span class="p">;</span>
    <span class="n">boundsMin</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">boundsMin</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="p">-</span><span class="m">0.5f</span> <span class="p">*</span> <span class="n">distributionRange</span><span class="p">;</span>
    <span class="n">boundsMax</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">boundsMax</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="p">-</span><span class="n">boundsMin</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">boundsMin</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
    <span class="n">boundsMax</span><span class="p">.</span><span class="n">y</span> <span class="p">=</span> <span class="n">distributionHeight</span><span class="p">;</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetVector</span><span class="p">(</span><span class="s">"boundsMin"</span><span class="p">,</span> <span class="n">boundsMin</span><span class="p">);</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetVector</span><span class="p">(</span><span class="s">"boundsMax"</span><span class="p">,</span> <span class="n">boundsMax</span><span class="p">);</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">GetKernelThreadGroupSizes</span><span class="p">(</span><span class="n">kernelPopulateID</span><span class="p">,</span> <span class="k">out</span> <span class="kt">uint</span> <span class="n">tx</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">groupSizeX</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">CeilToInt</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">instanceNumber</span> <span class="p">/</span> <span class="n">tx</span><span class="p">);</span>

    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernelPopulateID</span><span class="p">,</span> <span class="n">groupSizeX</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositionsGPU</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 생략</span>
    
    <span class="c1">// Dispatch(0, ...) =&gt; Dispatch(kernelUpdateID, ...) 변경</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernelUpdateID</span><span class="p">,</span> <span class="n">kernelUpdateGroupSizeX</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><br /></p>

<h2 id="3-진공-청소기-컴포넌트"><strong>[3] 진공 청소기 컴포넌트</strong></h2>

<ul>
  <li>임시 이동을 구현한다.</li>
</ul>

<details>
  <summary> 
VacuumCleanerHead.cs
</summary>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">100f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">moveSpeed</span> <span class="p">=</span> <span class="m">50f</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// On/Off</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">Space</span><span class="p">))</span>
        <span class="n">run</span> <span class="p">^=</span> <span class="k">true</span><span class="p">;</span>

    <span class="c1">// Move</span>
    <span class="kt">float</span> <span class="n">x</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Horizontal"</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">z</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Vertical"</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">y</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">E</span><span class="p">))</span> <span class="n">y</span> <span class="p">+=</span> <span class="m">1f</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">Q</span><span class="p">))</span> <span class="n">y</span> <span class="p">-=</span> <span class="m">1f</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">moveVec</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">).</span><span class="n">normalized</span> <span class="p">*</span> <span class="n">moveSpeed</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">LeftShift</span><span class="p">))</span>
        <span class="n">moveVec</span> <span class="p">*=</span> <span class="m">2f</span><span class="p">;</span>

    <span class="n">transform</span><span class="p">.</span><span class="nf">Translate</span><span class="p">(</span><span class="n">moveVec</span> <span class="p">*</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">,</span> <span class="n">Space</span><span class="p">.</span><span class="n">World</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><br /></p>

<h2 id="4-실행-결과"><strong>[4] 실행 결과</strong></h2>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135104033-6303ab1b-15fe-412d-9c64-05dc61cb09d3.gif" alt="2021_0927_Dust_3D" /></p>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="4-원뿔-흡수-영역-구현">4. 원뿔 흡수 영역 구현</h1>
<hr />

<p>구형 범위에서 흡수하는 것은 블랙홀이나 마찬가지이므로,</p>

<p>방향을 지정하여 해당 방향에서 원뿔 범위로 흡수할 수 있게 변경한다.</p>

<p><br /></p>

<h2 id="1-컴퓨트-쉐이더-1"><strong>[1] 컴퓨트 쉐이더</strong></h2>

<ul>
  <li>내적을 이용하여 원뿔 범위 흡수를 구현한다.</li>
</ul>

<details>
  <summary> 
DustCompute.compute
</summary>

  <div class="language-hlsl highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre></td><td class="rouge-code"><pre>
<span class="cp">#pragma kernel Populate
#pragma kernel Update
</span>
<span class="cp">#define TRUE 1
#define FALSE 0
</span>
<span class="k">struct</span> <span class="n">Dust</span>
<span class="p">{</span>
    <span class="kt">float3</span> <span class="n">position</span><span class="p">;</span>
    <span class="n">int</span> <span class="n">isAlive</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*************************************************
/*                     Variables
/*************************************************/</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">Dust</span><span class="o">&gt;</span> <span class="n">DustBuffer</span><span class="p">;</span>
<span class="kt">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">uint</span><span class="o">&gt;</span> <span class="n">aliveNumberBuffer</span><span class="p">;</span> <span class="c1">// 생존한 먼지 개수</span>

<span class="kt">float3</span> <span class="n">boundsMin</span><span class="p">;</span> <span class="c1">// 먼지 생성 영역 - 최소 지점</span>
<span class="kt">float3</span> <span class="n">boundsMax</span><span class="p">;</span> <span class="c1">// 먼지 생성 영역 - 최대 지점</span>

<span class="kt">float3</span> <span class="n">centerPos</span><span class="p">;</span>    <span class="c1">// 진공 청소기 입구 위치</span>
<span class="n">float</span> <span class="n">sqrRange</span><span class="p">;</span>      <span class="c1">// 먼지 흡입 범위(반지름)</span>
<span class="n">float</span> <span class="n">sqrDeathRange</span><span class="p">;</span> <span class="c1">// 먼지 소멸 범위(반지름)</span>
<span class="n">float</span> <span class="n">sqrForce</span><span class="p">;</span>

<span class="kt">float3</span> <span class="n">forward</span><span class="p">;</span>     <span class="c1">// 진공 청소기 전방 벡터</span>
<span class="n">float</span> <span class="n">dotThreshold</span><span class="p">;</span> <span class="c1">// 진공 청소기 원뿔 영역 내적 범위</span>

<span class="cm">/*************************************************
/*                     Methods
/*************************************************/</span>
<span class="n">float</span> <span class="nf">SqrMagnitude</span><span class="p">(</span><span class="kt">float3</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">vec</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">vec</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">vec</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 먼지 파괴</span>
<span class="kt">void</span> <span class="nf">DestroyDust</span><span class="p">(</span><span class="n">uint</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="nb">InterlockedAdd</span><span class="p">(</span><span class="n">aliveNumberBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*************************************************
/*                     Kernels
/*************************************************/</span>

<span class="c1">// 0 - 초기 생성</span>
<span class="c1">//void Populate (uint3 id : SV_DispatchThreadID)</span>

<span class="c1">// 1 - 실시간 업데이트</span>
<span class="p">[</span><span class="nb">numthreads</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">Update</span> <span class="p">(</span><span class="n">uint3</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isAlive</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    
    <span class="kt">float3</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>
    <span class="kt">float3</span> <span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">centerPos</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>
    <span class="n">float</span> <span class="n">sqrDist</span> <span class="o">=</span> <span class="n">SqrMagnitude</span><span class="p">(</span><span class="n">offs</span><span class="p">);</span>

    <span class="c1">// 입구 주변 - 먼지 소멸</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrDeathRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">DestroyDust</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 먼지 이동</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sqrDist</span> <span class="o">&lt;</span> <span class="n">sqrRange</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float3</span> <span class="n">dir</span> <span class="o">=</span> <span class="nb">normalize</span><span class="p">(</span><span class="n">offs</span><span class="p">);</span> <span class="c1">// 먼지 -&gt; 청소기 입구 방향</span>
        <span class="n">float</span> <span class="n">dotValue</span> <span class="o">=</span> <span class="nb">dot</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span> <span class="o">-</span><span class="n">dir</span><span class="p">);</span>

        <span class="c1">// 원뿔 범위 내에 있을 경우 빨아들이기</span>
        <span class="k">if</span><span class="p">(</span><span class="n">dotValue</span> <span class="o">&gt;</span> <span class="n">dotThreshold</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">float</span> <span class="n">weightedForce</span> <span class="o">=</span> <span class="n">sqrForce</span> <span class="o">/</span> <span class="n">sqrDist</span><span class="p">;</span>
            <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">+=</span> <span class="n">dir</span> <span class="o">*</span> <span class="n">weightedForce</span> <span class="o">*</span> <span class="n">dotValue</span><span class="p">;</span>

            <span class="c1">// 청소기 뒤편으로 넘어가면 먼지 소멸</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">dot</span><span class="p">(</span><span class="n">centerPos</span> <span class="o">-</span> <span class="n">DustBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">,</span> <span class="n">dir</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">DestroyDust</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><br /></p>

<h2 id="2-먼지-관리-컴포넌트-1"><strong>[2] 먼지 관리 컴포넌트</strong></h2>

<ul>
  <li>미리 내적 기준값을 계산하여 컴퓨트 쉐이더에 전달한다.</li>
</ul>

<details>
  <summary> 
DustManager.cs
</summary>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateDustPositionsGPU</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    
    <span class="k">ref</span> <span class="kt">var</span> <span class="n">head</span> <span class="p">=</span> <span class="k">ref</span> <span class="n">cleanerHead</span><span class="p">;</span>
    
    <span class="c1">// 청소기 전방 벡터(+Z)</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetVector</span><span class="p">(</span><span class="s">"forward"</span><span class="p">,</span> <span class="n">head</span><span class="p">.</span><span class="n">Forward</span><span class="p">);</span>
    
    <span class="c1">// Dot(A, B) = |A||B|cos(t) 일 때, A와 B가 정규 벡터이면</span>
    <span class="c1">// Dot(A, B) = cos(t) 이므로</span>
    <span class="c1">// 원뿔 각도 t를 이용해 미리 계산한 cos(t)를 컴퓨트 쉐이더에 전달한다.</span>
    <span class="n">DustCompute</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"dotThreshold"</span><span class="p">,</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">SuctionAngleRad</span><span class="p">));</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><br /></p>

<h2 id="3-진공-청소기-컴포넌트-1"><strong>[3] 진공 청소기 컴포넌트</strong></h2>

<ul>
  <li>숄더뷰 이동/회전을 구현한다.</li>
  <li>이동과 좌우 회전은 부모 오브젝트가 담당하고, 상하 회전은 이 컴포넌트가 있는 게임오브젝트가 담당한다.</li>
  <li>마우스 우클릭에 따라 마우스를 숨기고 드러낼 수 있도록 구현한다.</li>
  <li>원뿔 기즈모를 그린다.</li>
</ul>

<details>
  <summary> 
VacuumCleanerHead.cs
</summary>

  <div class="language-cs highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">bool</span> <span class="n">run</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">100f</span><span class="p">),</span> <span class="nf">Tooltip</span><span class="p">(</span><span class="s">"빨아들이는 힘"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">suctionForce</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>

<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1f</span><span class="p">,</span> <span class="m">50f</span><span class="p">),</span> <span class="nf">Tooltip</span><span class="p">(</span><span class="s">"빨아들이는 범위(거리)"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">suctionRange</span> <span class="p">=</span> <span class="m">5f</span><span class="p">;</span>

<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">90f</span><span class="p">),</span> <span class="nf">Tooltip</span><span class="p">(</span><span class="s">"빨아들이는 원뿔 각도"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">suctionAngle</span> <span class="p">=</span> <span class="m">45f</span><span class="p">;</span>

<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">5f</span><span class="p">),</span> <span class="nf">Tooltip</span><span class="p">(</span><span class="s">"먼지가 사망하는 영역 반지름"</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">deathRange</span> <span class="p">=</span> <span class="m">0.2f</span><span class="p">;</span>

<span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.01f</span><span class="p">,</span> <span class="m">100f</span><span class="p">)]</span>
<span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">moveSpeed</span> <span class="p">=</span> <span class="m">50f</span><span class="p">;</span>

<span class="k">private</span> <span class="n">Transform</span> <span class="n">parent</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">float</span> <span class="n">deltaTime</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">bool</span> <span class="n">mouseLocked</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

<span class="k">public</span> <span class="kt">bool</span> <span class="n">Running</span> <span class="p">=&gt;</span> <span class="n">run</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">SqrSuctionRange</span> <span class="p">=&gt;</span> <span class="n">suctionRange</span> <span class="p">*</span> <span class="n">suctionRange</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">SuctionForce</span> <span class="p">=&gt;</span> <span class="n">suctionForce</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">DeathRange</span> <span class="p">=&gt;</span> <span class="n">deathRange</span><span class="p">;</span>
<span class="k">public</span> <span class="kt">float</span> <span class="n">SuctionAngleRad</span> <span class="p">=&gt;</span> <span class="n">suctionAngle</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Deg2Rad</span><span class="p">;</span>

<span class="k">public</span> <span class="n">Vector3</span> <span class="n">Position</span> <span class="p">=&gt;</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
<span class="k">public</span> <span class="n">Vector3</span> <span class="n">Forward</span> <span class="p">=&gt;</span> <span class="n">transform</span><span class="p">.</span><span class="n">forward</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">parent</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">OnDrawGizmos</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Gizmos</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">blue</span><span class="p">;</span>
    <span class="nf">DrawConeGizmo</span><span class="p">(</span><span class="n">Position</span><span class="p">,</span> <span class="n">suctionRange</span><span class="p">,</span> <span class="n">suctionAngle</span><span class="p">);</span>

    <span class="c1">//Gizmos.color = Color.red;</span>
    <span class="c1">//Gizmos.DrawWireSphere(Position, deathRange);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">deltaTime</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>

    <span class="nf">MouseControl</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mouseLocked</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">Move</span><span class="p">();</span>
        <span class="nf">Rotate</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">MouseControl</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// On/Off</span>
    <span class="n">run</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetMouseButton</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>

    <span class="c1">// 마우스 보이기/숨기기</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetMouseButtonDown</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">mouseLocked</span> <span class="p">^=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">Cursor</span><span class="p">.</span><span class="n">lockState</span> <span class="p">=</span> <span class="n">mouseLocked</span> <span class="p">?</span> <span class="n">CursorLockMode</span><span class="p">.</span><span class="n">Locked</span> <span class="p">:</span> <span class="n">CursorLockMode</span><span class="p">.</span><span class="n">None</span><span class="p">;</span>
        <span class="n">Cursor</span><span class="p">.</span><span class="n">visible</span> <span class="p">=</span> <span class="p">!</span><span class="n">mouseLocked</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Move</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">x</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Horizontal"</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">z</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Vertical"</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">y</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">Space</span><span class="p">))</span> <span class="n">y</span> <span class="p">+=</span> <span class="p">.</span><span class="m">5f</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">LeftControl</span><span class="p">))</span> <span class="n">y</span> <span class="p">-=</span> <span class="p">.</span><span class="m">5f</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">moveVec</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">).</span><span class="n">normalized</span> <span class="p">*</span> <span class="n">moveSpeed</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKey</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">LeftShift</span><span class="p">))</span>
        <span class="n">moveVec</span> <span class="p">*=</span> <span class="m">2f</span><span class="p">;</span>

    <span class="n">parent</span><span class="p">.</span><span class="nf">Translate</span><span class="p">(</span><span class="n">moveVec</span> <span class="p">*</span> <span class="n">deltaTime</span><span class="p">,</span> <span class="n">Space</span><span class="p">.</span><span class="n">Self</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Rotate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">v</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Mouse X"</span><span class="p">)</span> <span class="p">*</span> <span class="n">deltaTime</span> <span class="p">*</span> <span class="m">100f</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">h</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetAxisRaw</span><span class="p">(</span><span class="s">"Mouse Y"</span><span class="p">)</span> <span class="p">*</span> <span class="n">deltaTime</span> <span class="p">*</span> <span class="m">100f</span><span class="p">;</span>

    <span class="c1">// 부모 : 좌우 회전</span>
    <span class="n">parent</span><span class="p">.</span><span class="n">localRotation</span> <span class="p">*=</span> <span class="n">Quaternion</span><span class="p">.</span><span class="nf">Euler</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>

    <span class="c1">// 상하 회전</span>
    <span class="n">Vector3</span> <span class="n">eRot</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">localEulerAngles</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">nextX</span> <span class="p">=</span> <span class="n">eRot</span><span class="p">.</span><span class="n">x</span> <span class="p">-</span> <span class="n">h</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="m">0f</span> <span class="p">&lt;</span> <span class="n">nextX</span> <span class="p">&amp;&amp;</span> <span class="n">nextX</span> <span class="p">&lt;</span> <span class="m">90f</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">eRot</span><span class="p">.</span><span class="n">x</span> <span class="p">=</span> <span class="n">nextX</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">transform</span><span class="p">.</span><span class="n">localEulerAngles</span> <span class="p">=</span> <span class="n">eRot</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// origin : 원뿔 꼭대기</span>
<span class="c1">// height : 원뿔 높이</span>
<span class="c1">// angle  : 원뿔 각도</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">DrawConeGizmo</span><span class="p">(</span><span class="n">Vector3</span> <span class="n">origin</span><span class="p">,</span> <span class="kt">float</span> <span class="n">height</span><span class="p">,</span> <span class="kt">float</span> <span class="n">angle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sample</span> <span class="p">=</span> <span class="m">24</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">deltaRad</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">PI</span> <span class="p">*</span> <span class="m">2f</span> <span class="p">/</span> <span class="n">sample</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">circleRadius</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Tan</span><span class="p">(</span><span class="n">angle</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Deg2Rad</span><span class="p">)</span> <span class="p">*</span> <span class="n">height</span><span class="p">;</span>
    <span class="n">Vector3</span> <span class="n">forward</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">forward</span> <span class="p">*</span> <span class="n">height</span><span class="p">;</span>

    <span class="n">Vector3</span> <span class="n">prevPoint</span> <span class="p">=</span> <span class="k">default</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="n">sample</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">float</span> <span class="n">delta</span> <span class="p">=</span> <span class="n">deltaRad</span> <span class="p">*</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">Vector3</span> <span class="n">circlePoint</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sin</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span> <span class="m">0f</span><span class="p">)</span> <span class="p">*</span> <span class="n">circleRadius</span><span class="p">;</span>
        <span class="n">circlePoint</span> <span class="p">+=</span> <span class="n">forward</span><span class="p">;</span>
        <span class="n">circlePoint</span> <span class="p">=</span> <span class="n">circlePoint</span><span class="p">.</span><span class="n">normalized</span> <span class="p">*</span> <span class="n">height</span><span class="p">;</span>

        <span class="n">circlePoint</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="nf">TransformPoint</span><span class="p">(</span><span class="n">circlePoint</span><span class="p">);</span>

        <span class="n">Gizmos</span><span class="p">.</span><span class="nf">DrawLine</span><span class="p">(</span><span class="n">circlePoint</span><span class="p">,</span> <span class="n">origin</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="n">Gizmos</span><span class="p">.</span><span class="nf">DrawLine</span><span class="p">(</span><span class="n">circlePoint</span><span class="p">,</span> <span class="n">prevPoint</span><span class="p">);</span>
        <span class="n">prevPoint</span> <span class="p">=</span> <span class="n">circlePoint</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<p><br /></p>

<h2 id="4-실행-결과-1"><strong>[4] 실행 결과</strong></h2>

<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/42164422/135104053-80e78eea-bd33-4ea5-8990-29f7d43c1f61.gif" alt="2021_0927_Dust_3D_Cone" /></p>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="5-먼지-속도-가속도-계산">5. 먼지 속도, 가속도 계산</h1>
<hr />

<p>먼지의 속도를 새로운 컴퓨트 버퍼에 저장한다.</p>

<p>공기 저항력, 마찰력, 중력을 계산한다.</p>

<!--



-->

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="6-메시-변경-텍스쳐-적용">6. 메시 변경, 텍스쳐 적용</h1>
<hr />

<p>Cube 메시 대신 +Y를 바라보는 Quad 메시를 사용한다.</p>

<p>렌더큐를 Transparent로 바꾸고, 먼지 텍스쳐를 적용한다.</p>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="7-애셋-적용">7. 애셋 적용</h1>
<hr />

<ul>
  <li>예쁜 방 꾸미기</li>
  <li>진공 청소기 모델링 적용하기</li>
</ul>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<!-- 

TODO

시뮬레이션이라는 이름에 맞게

- 흩날리는 움직임 구현

- 플레인, 큐브, 스피어 등등 충돌과 미끄러짐, 마찰 등 구현

-->

<h1 id="github-link">Github Link</h1>
<hr />
<ul>
  <li></li>
</ul>

<p><br /></p>

<!-- --------------------------------------------------------------------------- -->

<h1 id="references">References</h1>
<hr />
<ul>
  <li><a href="https://www.youtube.com/watch?v=PGk0rnyTa1U">https://www.youtube.com/watch?v=PGk0rnyTa1U</a></li>
  <li><a href="https://docs.unity3d.com/ScriptReference/Graphics.DrawMeshInstancedIndirect.html">https://docs.unity3d.com/ScriptReference/Graphics.DrawMeshInstancedIndirect.html</a></li>
  <li><a href="https://github.com/ColinLeung-NiloCat/UnityURP-MobileDrawMeshInstancedIndirectExample">https://github.com/ColinLeung-NiloCat/UnityURP-MobileDrawMeshInstancedIndirectExample</a></li>
</ul>


      </div>

      <div class="post-tail-wrapper text-muted">

        <!-- categories -->
        
        <div class="post-meta mb-3">
          <i class="far fa-folder-open fa-fw mr-1"></i>
          
            <a href='/categories/unity/'>Unity</a>,
            <a href='/categories/unity-study/'>Unity Study</a>
        </div>
        

        <!-- tags -->
        
        <div class="post-tags">
          <i class="fa fa-tags fa-fw mr-1"></i>
          
          <a href="/tags/unity/"
            class="post-tag no-text-decoration" >unity</a>
          
          <a href="/tags/csharp/"
            class="post-tag no-text-decoration" >csharp</a>
          
          </div>
        

        <div class="post-tail-bottom
          d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
          
          <div class="license-wrapper">
            This post is licensed under
            <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
            by the author.
          </div>
          

          <!--
 Post sharing snippet

 v2.1
 https://github.com/cotes2020/jekyll-theme-chirpy
 © 2019 Cotes Chung
 Published under the MIT License
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=유니티 - 진공 청소기, 먼지 시뮬레이션 - Rito15&url=https://rito15.github.io/posts/unity-million-dust-simulation/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=유니티 - 진공 청소기, 먼지 시뮬레이션 - Rito15&u=https://rito15.github.io/posts/unity-million-dust-simulation/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://telegram.me/share?text=유니티 - 진공 청소기, 먼지 시뮬레이션 - Rito15&url=https://rito15.github.io/posts/unity-million-dust-simulation/" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i class="fa-fw fas fa-link small" onclick="copyLink()"
        data-toggle="tooltip" data-placement="top" title="Copy link"></i>

  </span>
</div>


        </div><!-- .post-tail-bottom -->

      </div><!-- div.post-tail -->

    </div> <!-- .post -->


  </div> <!-- #post-wrapper -->

  

  

  <!--
  The Pannel on right side (Desktop views)
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->

<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

  <div class="access">

  














  

    <div id="access-lastmod" class="post">
      <span>Recent Update</span>
      <ul class="post-content pl-0 pb-1 ml-1 mt-2">

      
        
        
        
        <li><a href="/posts/unity-compute-shader/">유니티 - 컴퓨트 쉐이더(Compute Shader)</a></li>
      
        
        
        
        <li><a href="/posts/amplify-shader-60-nodes-for-beginners/">앰플리파이 쉐이더 입문자를 위한 60가지 노드 모음</a></li>
      
        
        
        
        <li><a href="/posts/unity-shader-properties/">유니티 쉐이더 - 프로퍼티 메모</a></li>
      
        
        
        
        <li><a href="/posts/unity-shader-concept/">초보자를 위한 쉐이더 개념 간단 정리</a></li>
      
        
        
        
        <li><a href="/posts/hash-table/">자료구조 - 해시 테이블(Hash Table)</a></li>
      

      </ul>
    </div> <!-- #access-lastmod -->

  

  















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  
    <div id="access-tags">
      <span>Trending Tags</span>
      <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

      
        
        <a class="post-tag" href="/tags/csharp/">csharp</a>
      
        
        <a class="post-tag" href="/tags/unity/">unity</a>
      
        
        <a class="post-tag" href="/tags/editor/">editor</a>
      
        
        <a class="post-tag" href="/tags/shader/">shader</a>
      
        
        <a class="post-tag" href="/tags/memo/">memo</a>
      
        
        <a class="post-tag" href="/tags/graphics/">graphics</a>
      
        
        <a class="post-tag" href="/tags/opengl/">opengl</a>
      
        
        <a class="post-tag" href="/tags/thread/">thread</a>
      
        
        <a class="post-tag" href="/tags/amplify/">amplify</a>
      
        
        <a class="post-tag" href="/tags/plugin/">plugin</a>
      

      </div>
    </div>
  
  </div> <!-- .access -->

  
    <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
      <span class="pl-3 pt-2 mb-2">Contents</span>
      <nav id="toc" data-toggle="toc"></nav>
    </div>
  

</div> <!-- #panel-wrapper -->


</div> <!-- .row -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.

 v2.0
 https://github.com/cotes2020/jekyll-theme-chirpy
 © 2019 Cotes Chung
 Published under the MIT License
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/unity-object-pooling/">
          <div class="card-body">
            <!--
  Date format snippet

  v2.4.1
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT License
-->
<span class="timeago small"
  >

  
  

  
    Aug  6
  

  <i class="unloaded">2021-08-06T01:22:00+09:00</i>

</span>
            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>유니티 - 오브젝트 풀링(Object Pooling)</h3>
            <div class="text-muted small">
              <p>
                





                1. 목표



  
    오브젝트 풀링 기법 이해하기
  
  
    Key 기반 다중 풀링 기법 이해하기
  
  
    오브젝트 풀 매니저 클래스 구현하기
  




2. 개념


게임오브젝트를 생성, 파괴하는 것은 순간적으로 큰 성능 소모 및 프레임 저하를 발생시킬 수 있다.

따라서 생성, 파괴 대신 활성화, 비활성화 방식을 사용하면 ...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/behavior-tree/">
          <div class="card-body">
            <!--
  Date format snippet

  v2.4.1
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT License
-->
<span class="timeago small"
  >

  
  

  
    Jan  5
  

  <i class="unloaded">2021-01-05T00:26:00+09:00</i>

</span>
            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>유니티 - 비헤이비어 트리(Behavior Tree)</h3>
            <div class="text-muted small">
              <p>
                





                개념



  FSM (Finite State Machine)의 단점을 보완하기 위해 만들어진 기법
  FSM에서는 상태 전이 조건을 모두 각각의 상태에서 검사하지만, BT에서는 상태 동작 뿐만 아니라 전이 조건도 노드로 관리한다.
  노드 그래프를 통해 시각화하거나 params, 빌더 패턴 등을 활용하여 스크립트 내에서도 가독성 좋게 구성할 수 있다...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/ray-marching/">
          <div class="card-body">
            <!--
  Date format snippet

  v2.4.1
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT License
-->
<span class="timeago small"
  >

  
  

  
    Jan 19
  

  <i class="unloaded">2021-01-19T23:15:00+09:00</i>

</span>
            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>레이 마칭(Ray Marching)</h3>
            <div class="text-muted small">
              <p>
                





                레이 마칭이란?



  
    모델의 정점 데이터를 이용하는 기존의 3D 렌더링 방식과는 달리, 레이를 전진시켜(Ray Marching) 카메라로부터 픽셀마다 가장 가까운 오브젝트 표면까지의 거리를 알아내고, 이를 활용해 오브젝트를 그려내는 기법
  
  
    레이 마칭의 모든 오브젝트들은 거리 함수(SDF : Signed Distance Fu...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->



    <!--
  Navigation buttons at the bottom of the post.

  v2.1
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2020 Cotes Chung
  MIT License
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/unity-shader-random-functions/" class="btn btn-outline-primary">
    <p>유니티 쉐이더 - 랜덤 함수들</p>
  </a>
  

  
  <a href="/posts/unity-srgb-linear-gamma-color-space/" class="btn btn-outline-primary">
    <p>유니티 - sRGB, Linear, Gamma 컬러 스페이스</p>
  </a>
  

</div>

    

    </div> <!-- #post-extend-wrapper -->

  </div> <!-- .col-* -->

</div> <!-- .row -->



<script>
/* 코드 블록 우측 상단 Copy 버튼 */
const codes = document.querySelectorAll('.code-button-header + .highlighter-rouge .rouge-code');
const copyCodeButtons = document.querySelectorAll('.copy-code-button');

copyCodeButtons.forEach((copyCodeButton, index) => {
  copyCodeButton.addEventListener('click', () => {
    window.navigator.clipboard.writeText(codes[index].innerText.slice(0, -1));
    copyCodeButton.classList.add('copied');

    setTimeout(() => {
      copyCodeButton.classList.remove('copied');
    }, 2000);
  });
});
</script>


  <!-- image lazy load: https://github.com/ApoorvSaxena/lozad.js -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script>

<script type="text/javascript">
  const imgs = document.querySelectorAll('.post-content img');
  const observer = lozad(imgs);
  observer.observe();
</script>




        <!--
  The Footer
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center">
    <div class="footer-left">
      <p class="mb-0">
        © 2021
        <a href="https://github.com/rito15">Rito15</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        Powered by
        <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
        with
        <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a>
        theme.
      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-xl-11 post-content">
    <div id="search-hints">
      <h4 class="text-muted mb-4">Trending Tags</h4>

      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



      
        
        <a class="post-tag" href="/tags/csharp/">csharp</a>
      
        
        <a class="post-tag" href="/tags/unity/">unity</a>
      
        
        <a class="post-tag" href="/tags/editor/">editor</a>
      
        
        <a class="post-tag" href="/tags/shader/">shader</a>
      
        
        <a class="post-tag" href="/tags/memo/">memo</a>
      
        
        <a class="post-tag" href="/tags/graphics/">graphics</a>
      
        
        <a class="post-tag" href="/tags/opengl/">opengl</a>
      
        
        <a class="post-tag" href="/tags/thread/">thread</a>
      
        
        <a class="post-tag" href="/tags/amplify/">amplify</a>
      
        
        <a class="post-tag" href="/tags/plugin/">plugin</a>
      

    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    
      <!--
  mermaid-js loader
-->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  $(function() {
    let initTheme = "default";

    if ($("html[mode=dark]").length > 0
      || ($("html[mode]").length == 0
        && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) {
      initTheme = "dark";
    }

    let mermaidConf = {
      theme: initTheme  /* <default|dark|forest|neutral> */
    };

    /* Markdown converts to HTML */
    $("pre").has("code.language-mermaid").each(function() {
      let svgCode = $(this).children().html();
      $(this).addClass("unloaded");
      $(this).after(`<div class=\"mermaid\">${svgCode}</div>`);
    });

    mermaid.initialize(mermaidConf);
  });
</script>

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="https://rito15.github.io{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    <div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div>    <div><i class="fa fa-tag fa-fw"></i>{tags}</div>  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>'
});
</script>


    <!-- 2021-06-29 추가 : 애널리틱스 적용 -->
    <!--
  The GA snippet
  v2.0
  https://github.com/cotes2020/jekyll-theme-chirpy
  © 2017-2019 Cotes Chung
  MIT License
-->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JV8DN2JPP7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JV8DN2JPP7');
</script>

  </body>

</html>

